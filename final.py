import requests
from bs4 import BeautifulSoup, XMLParsedAsHTMLWarning
import warnings
from datetime import datetime, timedelta
from collections import defaultdict
import sys

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# ê²½ê³  ë©”ì‹œì§€ ë¬´ì‹œ ì„¤ì • (XML ë¬¸ì„œë¥¼ HTML íŒŒì„œë¡œ íŒŒì‹±í•  ë•Œ ë°œìƒí•˜ëŠ” ê²½ê³  ì–µì œ)
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
warnings.filterwarnings("ignore", category=XMLParsedAsHTMLWarning)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 1) í™•ì¥ëœ ì§€ì—­ëª… â†” ê¸°ìƒì²­ ê²©ì ì¢Œí‘œ ë§¤í•‘ (ì˜ˆì‹œ)
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
REGION_GRID = {
    # ìˆ˜ë„ê¶Œ
    'ì„œìš¸':    (60, 127),
    'ì¸ì²œ':    (55, 124),
    'ìˆ˜ì›':    (60, 120),
    'ì˜ì •ë¶€':  (61, 125),
    'ì´ì²œ':    (60, 121),
    'íŒŒì£¼':    (56, 131),

    # ê°•ì›ë„
    'ì¶˜ì²œ':    (67, 115),
    'ê°•ë¦‰':    (92, 132),
    'ì†ì´ˆ':    (102, 139),
    'ì›ì£¼':    (61, 121),
    'íƒœë°±':    (79, 137),

    # ì¶©ì²­ë¶ë„
    'ì²­ì£¼':    (69, 107),
    'ì¶©ì£¼':    (69, 126),
    'ì œì²œ':    (74, 134),

    # ì¶©ì²­ë‚¨ë„
    'ëŒ€ì „':    (67, 100),
    'ì²œì•ˆ':    (64, 107),
    'ê³µì£¼':    (65, 111),
    'ë³´ë ¹':    (62, 80),
    'ì„œì‚°':    (53, 95),

    # ì „ë¼ë¶ë„
    'ì „ì£¼':    (63, 89),
    'êµ°ì‚°':    (62, 84),
    'ë‚¨ì›':    (60, 77),

    # ì „ë¼ë‚¨ë„
    'ê´‘ì£¼':    (58, 74),
    'ì—¬ìˆ˜':    (69, 62),
    'ìˆœì²œ':    (55, 74),
    'ëª©í¬':    (51, 58),

    # ê²½ìƒë¶ë„
    'ëŒ€êµ¬':    (89, 90),
    'í¬í•­':    (98, 87),
    'ê²½ì£¼':    (89, 83),
    'ì•ˆë™':    (89, 103),
    'ìš¸ì§„':    (105, 106),

    # ê²½ìƒë‚¨ë„
    'ë¶€ì‚°':    (97, 74),
    'ìš¸ì‚°':    (102, 84),
    'ì°½ì›':    (89, 73),
    'ê±°ì œ':    (95, 76),
    'í†µì˜':    (92, 74),

    # ì œì£¼ë„
    'ì œì£¼':    (52, 38),
    'ì„œê·€í¬':  (52, 36),
}

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 2) ê¸°ìƒì²­ ë™ë„¤ì˜ˆë³´ RSSì—ì„œ ì¼ìë³„ ìµœëŒ€ ê°•ìˆ˜í™•ë¥ (pop)ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
def fetch_daily_max_pop(gridx: int, gridy: int) -> dict:
    """
    ê¸°ìƒì²­ ë™ë„¤ì˜ˆë³´ RSS(queryDFS.jsp)ë¥¼ í˜¸ì¶œí•˜ì—¬,
    ì˜¤ëŠ˜(0)ë¶€í„° 6ì¼ì°¨(6)ê¹Œì§€ì˜ ì¼ë³„ ìµœëŒ€ ê°•ìˆ˜í™•ë¥ ì„ ë°˜í™˜í•œë‹¤.
    ë°˜í™˜ í˜•ì‹: { day_offset(int 0~6): max_pop(int 0~100), ... }
    """
    url = "https://www.kma.go.kr/wid/queryDFS.jsp"
    resp = requests.get(url, params={"gridx": gridx, "gridy": gridy})
    resp.encoding = 'utf-8'
    resp.raise_for_status()

    # BeautifulSoup ê²½ê³ ëŠ” ìœ„ì—ì„œ ë¬´ì‹œí•˜ë„ë¡ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ 'html.parser'ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ë„ ê²½ê³ ê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    soup = BeautifulSoup(resp.text, 'html.parser')
    data_nodes = soup.find_all('data')

    pops_by_day = defaultdict(int)
    for node in data_nodes:
        day_off = int(node.find('day').text)    # 0: ì˜¤ëŠ˜, 1: ë‚´ì¼, ...
        pop = int(node.find('pop').text)        # í•´ë‹¹ ì‹œê° ê°•ìˆ˜í™•ë¥ 
        if 0 <= day_off < 7:
            pops_by_day[day_off] = max(pops_by_day[day_off], pop)

    return {d: pops_by_day.get(d, 0) for d in range(7)}

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 3) ì—°ì†ëœ â€œë§‘ì€ ë‚ (ê°•ìˆ˜í™•ë¥ <10%)â€ êµ¬ê°„ì„ ì°¾ì•„ì£¼ëŠ” í•¨ìˆ˜
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
def find_clear_sequences(max_pops: dict) -> list:
    """
    max_pops: {0:pop0, 1:pop1, â€¦, 6:pop6}
    pop < 10 â†’ â€œë§‘ìŒâ€, pop â‰¥ 10 â†’ â€œë¹„ì˜´â€.
    ì—°ì†ëœ ë§‘ì€ ë‚ (ì¼ì°¨ ë²ˆí˜¸)ë“¤ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë¬¶ì–´ ë°˜í™˜.
    ì˜ˆ) max_pops = {0:5, 1:0, 2:60, 3:8, 4:0, 5:0, 6:15}
       ë°˜í™˜: [[0, 1], [3, 4, 5]]
    """
    sequences = []
    current_seq = []

    for day_off in range(7):
        pop = max_pops.get(day_off, 0)
        if pop < 10:   # â€œë§‘ìŒâ€ ì¡°ê±´
            current_seq.append(day_off)
        else:
            if current_seq:
                sequences.append(current_seq)
                current_seq = []
    if current_seq:
        sequences.append(current_seq)

    return sequences

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 4) ë©”ë‰´ 1: íŠ¹ì • ì§€ì—­ì˜ â€œì—°ì†ëœ ë§‘ì€ ë‚ â€ ì¶”ì²œ (ì¶”ì²œ í›„ ì¢…ë£Œ)
#    - ì„¤ëª… ë¬¸êµ¬ ì—†ì´ ê°„ë‹¨íˆ ë‚ ì§œ ëª©ë¡ë§Œ ì¶œë ¥
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
def menu_recommend_dates_for_region():
    print("\n[ì—¬í–‰ê°€ê¸° ì¢‹ì€ ë‚  ì¶”ì²œ]")
    region = input("ê°€ê³  ì‹¶ì€ ì§€ì—­ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì„œìš¸) â–¶ ").strip()
    if region not in REGION_GRID:
        print(f"âš ï¸ ë“±ë¡ëœ ì§€ì—­ì´ ì•„ë‹™ë‹ˆë‹¤: \"{region}\"")
        print("   ì‚¬ìš© ê°€ëŠ¥í•œ ì§€ì—­ ëª©ë¡:", ", ".join(REGION_GRID.keys()))
        sys.exit(0)

    gridx, gridy = REGION_GRID[region]
    max_pops = fetch_daily_max_pop(gridx, gridy)
    sequences = find_clear_sequences(max_pops)

    today = datetime.now().date()

    if not sequences:
        print(f"\n{region} ì§€ì—­ì—ëŠ” ì•ìœ¼ë¡œ 7ì¼ê°„ ë§‘ì€ ì—°ì† êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤.")
        sys.exit(0)

    print(f"\nğŸ‰ {region} ì§€ì—­ì˜ ì—°ì†ëœ ë§‘ì€ ë‚ :")
    for seq in sequences:
        start_off = seq[0]
        end_off = seq[-1]
        start_date = today + timedelta(days=start_off)
        end_date = today + timedelta(days=end_off)

        if start_off == end_off:
            print(f"  â€¢ {start_date} (ë‹¨ì¼ ë§‘ìŒ)")
        else:
            print(f"  â€¢ {start_date} ~ {end_date} (ì—°ì† {len(seq)}ì¼ ë§‘ìŒ)")
    sys.exit(0)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 5) ë©”ë‰´ 2: ë‚ ì§œ ë²”ìœ„ ë‚´ â€œë§‘ì€ ë‚ â€ì´ ê°€ì¥ ë§ì€ ì§€ì—­ ì¶”ì²œ (ìƒìœ„ 3ê°œë§Œ ì¶œë ¥)
#    - pop_sum ì—†ì´, ì§€ì—­ëª…ë§Œ ì¶œë ¥
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
def menu_recommend_region_for_dates():
    print("\n[ì—¬í–‰ê°€ê¸° ì¢‹ì€ ì§€ì—­ ì¶”ì²œ]")
    print("ë‚ ì§œ ì…ë ¥ í˜•ì‹ ì˜ˆì‹œ: 3.21-3.25  (ì›”.ì¼-ì›”.ì¼)")
    date_range = input("ëª‡ì›” ë©°ì¹ ë¶€í„° ëª‡ì›” ë©°ì¹ ê¹Œì§€ â–¶ ").strip()

    try:
        start_str, end_str = date_range.split('-')
        sm, sd = start_str.split('.')
        em, ed = end_str.split('.')
        year = datetime.now().year

        start_date = datetime(year=year, month=int(sm), day=int(sd)).date()
        end_date   = datetime(year=year, month=int(em), day=int(ed)).date()
    except Exception:
        print("âš ï¸ ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆì‹œ: 3.21-3.25")
        sys.exit(0)

    if end_date < start_date:
        print("âš ï¸ ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ì•ì„¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        sys.exit(0)

    today = datetime.now().date()
    delta0 = (start_date - today).days
    delta1 = (end_date - today).days

    # 0~6ì¼ì°¨ ì˜ˆë³´ ë²”ìœ„ ë°–ì´ë©´ ì˜¤ë¥˜ ì²˜ë¦¬
    if delta1 < 0 or delta0 > 6:
        print("\nâš ï¸ ì…ë ¥í•˜ì‹  ë‚ ì§œê°€ ì•ìœ¼ë¡œ 7ì¼ ì˜ˆë³´ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.")
        sys.exit(0)

    # ì˜ˆë³´ ê°€ëŠ¥ ì¼ì°¨(0~6) ë¦¬ìŠ¤íŠ¸ë¡œ ì¶”ì¶œ
    day_offsets = [d for d in range(delta0, delta1 + 1) if 0 <= d < 7]
    if not day_offsets:
        print("\nâš ï¸ ì…ë ¥í•˜ì‹  ë‚ ì§œ ì¤‘ ì˜ˆë³´ ê°€ëŠ¥í•œ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤.")
        sys.exit(0)

    # 1) ê° ì§€ì—­ë³„ë¡œ â€œë§‘ì€ ë‚ (ê°•ìˆ˜í™•ë¥ <10%)â€ ê°œìˆ˜ë§Œ ê¸°ë¡
    region_clear_counts = {}
    max_clear_days = -1

    for region, (gx, gy) in REGION_GRID.items():
        max_pops = fetch_daily_max_pop(gx, gy)
        clear_count = sum(1 for d in day_offsets if max_pops.get(d, 0) < 10)
        region_clear_counts[region] = clear_count
        if clear_count > max_clear_days:
            max_clear_days = clear_count

    if max_clear_days <= 0:
        print("\nâš ï¸ í•´ë‹¹ ê¸°ê°„ ë‚´ ë§‘ì€ ë‚ (ê°•ìˆ˜í™•ë¥ <10%)ì´ ì—†ìŠµë‹ˆë‹¤.")
        sys.exit(0)

    # 2) â€œë§‘ì€ ë‚  ê°œìˆ˜â€ê°€ ìµœëŒ€ì¸ ì§€ì—­ë“¤ë§Œ ì¶”ë ¤ë‚¸ ë’¤, ìƒìœ„ 3ê°œë§Œ ì¶œë ¥
    candidates = [r for r, cnt in region_clear_counts.items() if cnt == max_clear_days]
    top3 = candidates[:3]  # í›„ë³´êµ°ì´ 3ê°œ ì´ìƒì¼ ê²½ìš°, ê·¸ëƒ¥ ì²« 3ê°œë§Œ

    # 3) ê²°ê³¼ ì¶œë ¥
    print(f"\nğŸ‰ '{start_date} ~ {end_date}' ê¸°ê°„ ì¤‘ ë§‘ì€ ë‚ ì´ ê°€ì¥ ë§ì€ ì§€ì—­ (ì´ {max_clear_days}ì¼):")
    for idx, r in enumerate(top3, start=1):
        print(f"  {idx}. {r}")
    print()
    sys.exit(0)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 6) ë©”ì¸ ë©”ë‰´ (ë©”ë‰´ 3 ì‚­ì œ, ì¢…ë£Œ ì˜µì…˜ë§Œ ìœ ì§€)
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
def main_menu():
    while True:
        print("\n==============================")
        print(" ì›í•˜ì‹œëŠ” ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”:")
        print(" 1. ì—¬í–‰ê°€ê¸° ì¢‹ì€ ë‚  ì¶”ì²œ")
        print(" 2. ì—¬í–‰ê°€ê¸° ì¢‹ì€ ì§€ì—­ ì¶”ì²œ")
        print(" 0. ì¢…ë£Œ")
        print("==============================")
        choice = input("ë©”ë‰´ ë²ˆí˜¸ ì…ë ¥ â–¶ ").strip()

        if choice == '1':
            menu_recommend_dates_for_region()
        elif choice == '2':
            menu_recommend_region_for_dates()
        elif choice == '0':
            print("í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!")
            break
        else:
            print("âš ï¸ ì˜¬ë°”ë¥¸ ë©”ë‰´ ë²ˆí˜¸(0, 1, 2)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

if __name__ == "__main__":
    print("==========================================")
    print("   âœˆï¸  ì—¬í–‰ ìŠ¤ì¼€ì¤„ëŸ¬ v2.3  âœˆï¸")
    print("   (pop_sum ë° ì¶”ê°€ ì„¤ëª…ë¬¸êµ¬ ì œê±°, ë©”ë‰´ 3 ì‚­ì œ)")
    print("==========================================")
    main_menu()